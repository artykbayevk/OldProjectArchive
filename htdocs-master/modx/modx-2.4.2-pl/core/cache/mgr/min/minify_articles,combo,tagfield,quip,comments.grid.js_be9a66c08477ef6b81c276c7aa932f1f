var Articles=function(config){config=config||{};Articles.superclass.constructor.call(this,config);};Ext.extend(Articles,Ext.Component,{page:{},window:{},grid:{},tree:{},panel:{},combo:{},config:{},view:{},extra:{},connector_url:''});Ext.reg('Articles',Articles);Articles=new Articles();Articles.combo.PublishStatus=function(config){config=config||{};Ext.applyIf(config,{store:[[1,_('published')],[0,_('unpublished')]],name:'published',hiddenName:'published',triggerAction:'all',editable:false,selectOnFocus:false,preventRender:true,forceSelection:true,enableKeyEvents:true});Articles.combo.PublishStatus.superclass.constructor.call(this,config);};Ext.extend(Articles.combo.PublishStatus,MODx.combo.ComboBox);Ext.reg('articles-combo-publish-status',Articles.combo.PublishStatus);Articles.combo.FilterStatus=function(config){config=config||{};Ext.applyIf(config,{store:[['',_('articles.all')],['published',_('published')],['unpublished',_('unpublished')],['deleted',_('deleted')]],name:'filter',hiddenName:'filter',triggerAction:'all',editable:false,selectOnFocus:false,preventRender:true,forceSelection:true,enableKeyEvents:true,emptyText:_('articles.filter_ellipsis')});Articles.combo.FilterStatus.superclass.constructor.call(this,config);};Ext.extend(Articles.combo.FilterStatus,MODx.combo.ComboBox);Ext.reg('articles-combo-filter-status',Articles.combo.FilterStatus);Articles.PanelSpacer={html:'<br />',border:false,cls:'articles-panel-spacer'};;Articles.combo.Tag=function(config,getStore){config=config||{};Ext.applyIf(config,{name:'fake_tags',hiddenName:'fake_tags',displayField:'tag',valueField:'tag',fields:['tag'],mode:'remote',allowAddNewData:true,addNewDataOnBlur:false,itemDelimiterKey:188,triggerAction:'all',typeAheadDelay:50,minChars:1,typeAhead:true,editable:true,forceSelection:false,pageSize:20,url:Articles.connector_url,baseParams:{action:'extras/gettags'}});Ext.applyIf(config,{store:new Ext.data.JsonStore({url:config.url,root:'results',totalProperty:'total',fields:config.fields,errorReader:MODx.util.JSONReader,baseParams:config.baseParams||{},remoteSort:config.remoteSort||false,autoDestroy:true})});if(getStore===true){config.store.load();return config.store;}
Articles.combo.Tag.superclass.constructor.call(this,config);this.on('newitem',function(bs,v,f){v=v.split(',');Ext.each(v,function(item){item=item.replace(/^\s+|\s+$/g,'');var newObj={tag:item};bs.addNewItem(newObj);});});this.on('removeitem',function(combo){combo.lastQuery='';MODx.fireResourceFormChange();});this.on('blur',function(combo){if(combo.lastQuery){var v=combo.lastQuery.split(',');Ext.each(v,function(item){item=item.replace(/^\s+|\s+$/g,'');var newObj={tag:item};combo.addNewItem(newObj);});}});this.config=config;return this;};Ext.extend(Articles.combo.Tag,Ext.ux.form.SuperBoxSelect,{setValue:function(value){if(!this.rendered){this.value=value;return;}
this.removeAllItems().resetStore();this.remoteLookup=[];if(Ext.isEmpty(value)){return;}
var values=value;if(!Ext.isArray(value)){value=''+value;values=value.split(this.valueDelimiter);}
Ext.each(values,function(val){val=val.replace(/^\s+|\s+$/g,'');var record=this.findRecord(this.valueField,val);if(record){this.addRecord(record);}else if(this.mode==='remote'){this.remoteLookup.push(val);}},this);if(this.mode==='remote'){var q=this.remoteLookup.join(this.queryValuesDelimiter);this.doQuery(q,false,true);}}});Ext.reg('articles-combo-tag',Articles.combo.Tag);;Articles.extra.Tags=function(config){config=config||{};Ext.apply(config,{ignoreCase:false,valueField:'tag',displayField:'tag',minChars:3});Articles.extra.Tags.superclass.constructor.call(this,config);this.addEvents('additem','removeitem');};Ext.extend(Articles.extra.Tags,Ext.form.ComboBox,{mode:'local',hideTrigger:true,defaultAutoCreate:{tag:"input",type:"text",size:"24",autocomplete:"on"},myStore:new Ext.data.ArrayStore({autoDestroy:true,storeId:'tagsStore',idIndex:0,fields:['tag']}),store:new Ext.data.ArrayStore({autoDestroy:true,storeId:'autoCompleteStore',idIndex:0,fields:['tag'],data:[]}),initValue:function(){if(this.value!==undefined){this.setValue(this.value);}else if(!Ext.isEmpty(this.el.dom.value)&&this.el.dom.value!=this.emptyText){this.setValue(this.el.dom.value);}
this.originalValue=this.getFieldValue();},onFocus:function(){this.preFocus();if(this.focusClass){this.el.addClass(this.focusClass);}
if(!this.hasFocus){this.hasFocus=true;this.startValue=this.getFieldValue();this.fireEvent('focus',this);}},isDirty:function(){if(this.disabled||!this.rendered){return false;}
return String(this.getFieldValue())!==String(this.originalValue);},append:function(v){this.setValue([this.getFieldValue(),v].join(''));},getValue:function(){var restValues=this.getFieldValue();if(restValues==''||restValues==undefined)restValues='';restValues=restValues.split(/\s*[,]\s*/);Ext.each(restValues,function(value){var record=new Ext.data.Record({tag:value},value);this.myStore.add([record]);},this);return this.myStore.collect('tag').join();},setValue:function(v){while(this.insertedTagsEl.dom.firstChild!=null){this.insertedTagsEl.dom.firstChild.remove();}
this.myStore.clearData();if(v instanceof Array){v=v.join();}
this.addItems(v);},setFieldValue:function(v){var text=v;if(this.valueField){var r=this.findRecord(this.valueField,v);if(r){text=r.data[this.displayField];}else if(Ext.isDefined(this.valueNotFoundText)){text=this.valueNotFoundText;}}
this.lastSelectionText=text;if(this.hiddenField){this.hiddenField.value=Ext.value(v,'');}
Ext.form.ComboBox.superclass.setValue.call(this,text);this.value=v;return this;},getFieldValue:function(){return this.value;},onRender:function(ct,position){if(this.hiddenName&&!Ext.isDefined(this.submitValue)){this.submitValue=false;}
Ext.form.ComboBox.superclass.onRender.call(this,ct,position);this.el.parent().wrap({tag:'div',class:'bxr-field-tags x-superboxselect'});this.el.parent().wrap({tag:'div',class:'bxr-field-wrapper'});this.el.parentNode=this.el.parent().parent().parent();Ext.DomHelper.insertAfter(this.el.parent().parent(),{tag:'ul'});Ext.DomHelper.insertAfter(this.el.parent(),{tag:'button',html:'Add',class:'x-btn'});this.addButton=this.el.parentNode.child('button');this.insertedTagsEl=this.el.parentNode.child('ul');this.insertedTagsEl.wrap({tag:'div',class:'inserted-tags'});this.addButton.on('click',this.addItemsFromField,this);if(this.hiddenName){this.hiddenField=this.el.insertSibling({tag:'input',type:'hidden',name:this.hiddenName,id:(this.hiddenId||Ext.id())},'before',true);}
if(Ext.isGecko){this.el.dom.setAttribute('autocomplete','off');}
if(!this.lazyInit){this.initList();}else{this.on('focus',this.initList,this,{single:true});}},addItemsFromField:function(){this.addItems(this.getFieldValue());},addItems:function(items){items=Ext.isEmpty(items)?'':items;var values=items.split(/\s*[,]\s*/);Ext.each(values,function(value){if(this.ignoreCase){value=value.toLowerCase();}
if(value==''){return;}
var item=new Articles.extra.TagsItem({owner:this,renderTo:this.insertedTagsEl,value:value,listeners:{remove:function(item){this.fireEvent('removeitem',this,item);},scope:this}});item.render();this.fireEvent('additem',this,value);},this);this.setFieldValue();},doQuery:function(q,forceAll){this.value=q;q=Ext.isEmpty(q)?'':q;q=q.split(',');q=q[q.length-1];q=q.replace(/^\s+|\s+$/g,'');var qe={query:q,forceAll:forceAll,combo:this,cancel:false};if(this.fireEvent('beforequery',qe)===false||qe.cancel){return false;}
q=qe.query;forceAll=qe.forceAll;if(forceAll===true||(q.length>=this.minChars)){if(this.lastQuery!==q){this.lastQuery=q;if(this.mode=='local'){this.selectedIndex=-1;if(forceAll){this.store.clearFilter();}else{this.store.filter(this.displayField,q,true);}
this.onLoad();}else{this.store.baseParams[this.queryParam]=q;this.store.load({params:this.getParams(q)});this.expand();}}else{this.selectedIndex=-1;this.onLoad();}}},onSelect:function(record,index){if(this.fireEvent('beforeselect',this,record,index)!==false){var values=this.getFieldValue().split(/\s*[,]\s*/);values.pop();values.push(record.data[this.valueField||this.displayField]);values.push('');this.setFieldValue(values.join(', '));this.collapse();this.fireEvent('select',this,record,index);}}});Ext.reg('bxr-field-tags',Articles.extra.Tags);Articles.extra.TagsItem=function(config){Ext.apply(this,config);Ext.ux.form.SuperBoxSelectItem.superclass.constructor.call(this);this.addEvents('remove');};Ext.extend(Articles.extra.TagsItem,Ext.Component,{renderCurrentItem:true,initComponent:function(){Articles.extra.TagsItem.superclass.initComponent.call(this);this.renderCurrentItem=true;var itemsCount=this.owner.myStore.getCount();var record=new Ext.data.Record({tag:this.value},this.value);this.owner.myStore.add([record]);if(itemsCount==this.owner.myStore.getCount())this.renderCurrentItem=false;},onRender:function(ct,position){if(!this.renderCurrentItem)return true;Articles.extra.TagsItem.superclass.onRender.call(this,ct,position);var el=this.el;if(el){el.remove();}
this.el=el=ct.createChild({tag:'li'},ct.last());el.addClass('x-superboxselect-item');var btnEl=this.owner.navigateItemsWithTab?(Ext.isSafari?'button':'a'):'span';Ext.apply(el,{focus:function(){var c=this.down(btnEl+'.x-superboxselect-item-close');if(c){c.focus();}},preDestroy:function(){this.preDestroy();}.createDelegate(this)});el.update(this.value);var cfg={tag:btnEl,'class':'x-superboxselect-item-close',tabIndex:this.owner.navigateItemsWithTab?'0':'-1'};if(btnEl==='a'){cfg.href='#';}
this.lnk=el.createChild(cfg);this.lnk.on('click',function(){var record=new Ext.data.Record({tag:this.value},this.value);this.el.remove();this.owner.myStore.remove(this.owner.myStore.getById(this.value));this.fireEvent('remove',this,this.value);},this);},onDestroy:function(){Ext.destroy(this.lnk,this.el);Articles.extra.TagsItem.superclass.onDestroy.call(this);}});;var Quip=function(config){config=config||{};Quip.superclass.constructor.call(this,config);};Ext.extend(Quip,Ext.Component,{page:{},window:{},grid:{},tree:{},panel:{},combo:{},config:{}});Ext.reg('quip',Quip);var Quip=new Quip();;Quip.grid.Comments=function(config){config=config||{};this.sm=new Ext.grid.CheckboxSelectionModel();this.ident=config.ident||'quip-'+Ext.id();Ext.applyIf(config,{url:Quip.config.connector_url,baseParams:{action:'mgr/comment/getList',thread:config.thread||null,family:config.family||null},fields:['id','author','username','body','createdon','name','approved','deleted','ip','url','pagetitle','comments','website','email','cls'],paging:true,autosave:false,remoteSort:true,autoExpandColumn:'body',sm:this.sm,columns:[this.sm,{header:_('quip.comment'),dataIndex:'username',sortable:false,width:400,renderer:this.renderAuthor},{header:_('quip.posted'),dataIndex:'createdon',sortable:false,editable:false,align:'right',width:100,renderer:this._renderPosted},{header:_('quip.thread'),dataIndex:'url',sortable:false,editable:false,width:100,renderer:this._renderUrl}],viewConfig:{forceFit:true,enableRowBody:true,showPreview:true,getRowClass:function(rec,ri,p){var cls='quip-comment';if(!rec.data.approved)cls+=' quip-unapproved';if(rec.data.deleted)cls+=' quip-deleted';if(this.showPreview){p.body='<div class="quip-comment-body">'+rec.data.body+'</div>';return cls+' quip-comment-expanded';}
return cls+' quip-comment-collapsed';}},tbar:[{text:_('quip.bulk_actions'),menu:[{text:_('quip.approve_selected'),handler:this.approveSelected,scope:this},{text:_('quip.delete_selected'),handler:this.deleteSelected,scope:this},'-',{text:_('quip.remove_selected'),handler:this.removeSelected,scope:this}]},{text:_('quip.show_deleted'),handler:this.toggleDeleted,enableToggle:true,scope:this},'->',{xtype:'textfield',name:'search',id:this.ident+'-tf-search',emptyText:_('search')+'...',listeners:{'change':{fn:this.search,scope:this},'render':{fn:function(cmp){new Ext.KeyMap(cmp.getEl(),{key:Ext.EventObject.ENTER,fn:function(){this.fireEvent('change',this.getValue());this.blur();return true;},scope:cmp});},scope:this}}},{xtype:'button',id:this.ident+'-filter-clear',text:_('filter_clear'),listeners:{'click':{fn:this.clearFilter,scope:this}}}]});Quip.grid.Comments.superclass.constructor.call(this,config)};Ext.extend(Quip.grid.Comments,MODx.grid.Grid,{_addEnterKeyHandler:function(){this.getEl().addKeyListener(Ext.EventObject.ENTER,function(){this.fireEvent('change');},this);},clearFilter:function(){var s=this.getStore();s.baseParams.search='';Ext.getCmp(this.ident+'-tf-search').reset();this.getBottomToolbar().changePage(1);this.refresh();},search:function(tf,newValue,oldValue){var nv=newValue||tf;this.getStore().baseParams.search=nv;this.getBottomToolbar().changePage(1);this.refresh();return true;},renderAuthor:function(value,p,rec){return String.format('<span class="quip-author"><b>{1}</b>: <a href="mailto:{2}">{2}</a><br /><i>{0}</i></span>',value,rec.data.name,rec.data.email,rec.data.approved);return value;},_renderUrl:function(v,md,rec){return'<a href="'+rec.data.url+'" target="_blank">'+rec.data.pagetitle+'</a><br /><i>'+rec.data.comments+' '+_('quip.comments')+'</i>';},_renderPosted:function(v,md,rec){var cls='quip-posted';if(!rec.data.approved)cls+=' quip-unapproved';if(rec.data.deleted)cls+=' quip-deleted';return'<div class="'+cls+'">'+v+'<br /><span class="quip-ip">'+rec.data.ip+'</span></div>';},toggleDeleted:function(btn,e){var s=this.getStore();if(btn.pressed){s.setBaseParam('deleted',1);btn.setText(_('quip.hide_deleted'));}else{s.setBaseParam('deleted',0);btn.setText(_('quip.show_deleted'));}
this.getBottomToolbar().changePage(1);s.removeAll();this.refresh();},approveSelected:function(btn,e){var cs=this.getSelectedAsList();if(cs===false)return false;MODx.Ajax.request({url:this.config.url,params:{action:'mgr/comment/approveMultiple',comments:cs},listeners:{'success':{fn:function(r){this.getSelectionModel().clearSelections(true);this.refresh();},scope:this}}});return true;},unapproveSelected:function(btn,e){var cs=this.getSelectedAsList();if(cs===false)return false;MODx.Ajax.request({url:this.config.url,params:{action:'mgr/comment/unapproveMultiple',comments:cs},listeners:{'success':{fn:function(r){this.getSelectionModel().clearSelections(true);this.refresh();},scope:this}}});return true;},deleteSelected:function(btn,e){var cs=this.getSelectedAsList();if(cs===false)return false;MODx.Ajax.request({url:this.config.url,params:{action:'mgr/comment/deleteMultiple',comments:cs},listeners:{'success':{fn:function(r){this.getSelectionModel().clearSelections(true);this.refresh();},scope:this}}});return true;},undeleteSelected:function(btn,e){var cs=this.getSelectedAsList();if(cs===false)return false;MODx.Ajax.request({url:this.config.url,params:{action:'mgr/comment/undeleteMultiple',comments:cs},listeners:{'success':{fn:function(r){this.getSelectionModel().clearSelections(true);this.refresh();},scope:this}}});return true;},removeSelected:function(btn,e){var cs=this.getSelectedAsList();if(cs===false)return false;MODx.Ajax.request({url:this.config.url,params:{action:'mgr/comment/removeMultiple',comments:cs},listeners:{'success':{fn:function(r){this.getSelectionModel().clearSelections(true);this.refresh();},scope:this}}});return true;},updateComment:function(btn,e){if(!this.updateCommentWindow){this.updateCommentWindow=MODx.load({xtype:'quip-window-comment-update',record:this.menu.record,listeners:{'success':{fn:this.refresh,scope:this}}});}
this.updateCommentWindow.setValues(this.menu.record);this.updateCommentWindow.show(e.target);},rejectComment:function(btn,e){if(!this.rejectCommentWindow){this.rejectCommentWindow=MODx.load({xtype:'quip-window-comment-reject',record:this.menu.record,listeners:{'success':{fn:this.refresh,scope:this}}});}
this.rejectCommentWindow.setValues(this.menu.record);this.rejectCommentWindow.show(e.target);},approveComment:function(){MODx.Ajax.request({url:this.config.url,params:{action:'mgr/comment/approve',id:this.menu.record.id},listeners:{'success':{fn:this.refresh,scope:this}}});},unapproveComment:function(){MODx.Ajax.request({url:this.config.url,params:{action:'mgr/comment/unapprove',id:this.menu.record.id},listeners:{'success':{fn:this.refresh,scope:this}}});},deleteComment:function(){MODx.msg.confirm({title:_('warning'),text:_('quip.comment_delete_confirm'),url:this.config.url,params:{action:'mgr/comment/delete',id:this.menu.record.id},listeners:{'success':{fn:this.removeActiveRow,scope:this}}});},undeleteComment:function(){MODx.Ajax.request({url:this.config.url,params:{action:'mgr/comment/undelete',id:this.menu.record.id},listeners:{'success':{fn:this.refresh,scope:this}}});},removeComment:function(){MODx.msg.confirm({title:_('warning'),text:_('quip.comment_remove_confirm'),url:this.config.url,params:{action:'mgr/comment/remove',id:this.menu.record.id},listeners:{'success':{fn:this.removeActiveRow,scope:this}}});},verifyPerm:function(perm,rs){var valid=true;for(var i=0;i<rs.length;i++){if(rs[i].data.cls.indexOf(perm)==-1){valid=false;}}
return valid;},getMenu:function(){var m=[];if(this.getSelectionModel().getCount()>1){var rs=this.getSelectionModel().getSelections();if(this.verifyPerm('approve',rs)){m.push({text:_('quip.comment_approve_selected'),handler:this.approveSelected});m.push({text:_('quip.comment_unapprove_selected'),handler:this.unapproveSelected});}
if(this.verifyPerm('remove',rs)){if(m.length>0){m.push('-');}
m.push({text:_('quip.comment_delete_selected'),handler:this.deleteSelected});m.push({text:_('quip.comment_undelete_selected'),handler:this.undeleteSelected});m.push('-');m.push({text:_('quip.comment_remove_selected'),handler:this.removeSelected});}}else{var n=this.menu.record;var cls=n.cls.split(',');if(cls.indexOf('pupdate')!=-1){m.push({text:_('quip.comment_update'),handler:this.updateComment});}
if(cls.indexOf('papprove')!=-1&&n.approved==0){m.push({text:_('quip.comment_approve'),handler:this.approveComment})}else if(cls.indexOf('papprove')!=-1&&n.approved==1){m.push({text:_('quip.comment_unapprove'),handler:this.unapproveComment});}
if(cls.indexOf('premove')!=-1&&n.deleted==0){m.push({text:_('quip.comment_delete'),handler:this.deleteComment})}else if(cls.indexOf('premove')!=-1&&n.deleted==1){m.push({text:_('quip.comment_undelete'),handler:this.undeleteComment});}
if(cls.indexOf('premove')!=-1&&n.deleted==1){m.push('-');m.push({text:_('quip.comment_remove'),handler:this.removeComment});}}
if(m.length>0){this.addContextMenuItem(m);}}});Ext.reg('quip-grid-comments',Quip.grid.Comments);Quip.window.UpdateComment=function(config){config=config||{};Ext.applyIf(config,{title:_('quip.comment_update'),url:Quip.config.connector_url,baseParams:{action:'mgr/comment/update'},width:600,fields:[{xtype:'hidden',name:'id'},{xtype:'textfield',fieldLabel:_('quip.name'),name:'name',anchor:'90%'},{xtype:'textfield',fieldLabel:_('quip.email'),name:'email',anchor:'90%'},{xtype:'textfield',fieldLabel:_('quip.website'),name:'website',anchor:'90%'},{xtype:'statictextfield',fieldLabel:_('quip.ip'),name:'ip',anchor:'90%',submitValue:false},{xtype:'textarea',hideLabel:true,name:'body',width:550,grow:true}],keys:[]});Quip.window.UpdateComment.superclass.constructor.call(this,config);};Ext.extend(Quip.window.UpdateComment,MODx.Window);Ext.reg('quip-window-comment-update',Quip.window.UpdateComment);